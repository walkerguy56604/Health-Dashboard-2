name: YAML to Markdown

on:
  push:
    paths:
      - 'data/**/*.yaml'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Convert YAML to Markdown
        run: |
          mkdir -p docs
          for file in data/*.yaml; do
            base=$(basename "$file" .yaml)
            python3 - <<EOF
import yaml
file_path = "$file"
with open(file_path) as f:
    data = yaml.safe_load(f)

md_file = f"docs/{base}.md"
with open(md_file, "w") as out:
    out.write(f"# {data.get('date', 'No Date')}\\n\\n")
    out.write(f"**Summary:** {data.get('summary','')}\\n\\n")
    
    # Activities
    out.write("## Activities\\n")
    for act in data.get('activities', []):
        out.write(f"- {act['type']} ({act.get('start_time','')} - {act.get('end_time','')}): {act.get('details','')}\\n")
    
    # Nutrition
    out.write("\\n## Nutrition\\n")
    for meal in data.get('nutrition', {}).get('meals', []):
        out.write(f"- {meal['name']}: {', '.join(meal.get('items', []))} ({meal.get('calories',0)} cal)\\n")
    if data.get('nutrition', {}).get('snacks'):
        out.write(f"**Snacks:** {', '.join(data['nutrition']['snacks'])}\\n")
    out.write(f"**Total Calories:** {data.get('nutrition', {}).get('total_calories',0)}\\n")
    
    # Vitals
    out.write("\\n## Vitals\\n")
    for bp in data.get('vitals', {}).get('blood_pressure', []):
        out.write(f"- BP at {bp['time']}: {bp['systolic']}/{bp['diastolic']}\\n")
    hr = data.get('vitals', {}).get('heart_rate', {})
    if hr:
        out.write(f"- Resting HR: {hr.get('resting','')}\\n")
        out.write(f"- Post Exercise HR: {hr.get('post_exercise','')}\\n")
    
    # Notes 
    out.write("\\n## Notes\\n")
    out.write(data.get('notes',''))
EOF
          done

      - name: Commit & Push Markdown
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/
          git commit -m "Auto-update Markdown from YAML" || echo "No changes to commit"
          git push
