import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime

# Files
csv_file = "daily_activity_log.csv"
png_file = "daily_activity_combined_plot.png"

# Load CSV
df = pd.read_csv(csv_file)

# Add latest entry
new_entry = {
    "Timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    "Activity": "Strength Training Post-Rest",
    "BP_Systolic": 136,
    "BP_Diastolic": 70,
    "HeartRate": 94,
    "Glucose": 3.8
}

df = pd.concat([df, pd.DataFrame([new_entry])], ignore_index=True)

# Save CSV
df.to_csv(csv_file, index=False)

# Convert timestamp for plotting
df["Timestamp"] = pd.to_datetime(df["Timestamp"])

# Plot
fig, ax1 = plt.subplots(figsize=(11,6))

# Blood Pressure (Left Y-axis)
ax1.plot(df["Timestamp"], df["BP_Systolic"], marker="o", label="Systolic BP")
ax1.plot(df["Timestamp"], df["BP_Diastolic"], marker="o", label="Diastolic BP")
ax1.set_ylabel("Blood Pressure (mmHg)")
ax1.set_xlabel("Time")

# Highlight latest BP
ax1.scatter(df["Timestamp"].iloc[-1], df["BP_Systolic"].iloc[-1], s=120, zorder=5)
ax1.scatter(df["Timestamp"].iloc[-1], df["BP_Diastolic"].iloc[-1], s=120, zorder=5)

# Glucose (Right Y-axis)
ax2 = ax1.twinx()
ax2.plot(df["Timestamp"], df["Glucose"], marker="s", linestyle="--", label="Glucose")
ax2.set_ylabel("Glucose (mmol/L)")

# Titles & formatting
fig.suptitle("Daily Activity â€“ Blood Pressure & Glucose Trends")
fig.autofmt_xdate()

# Legends
lines_1, labels_1 = ax1.get_legend_handles_labels()
lines_2, labels_2 = ax2.get_legend_handles_labels()
ax1.legend(lines_1 + lines_2, labels_1 + labels_2, loc="upper left")

plt.tight_layout()
plt.savefig(png_file)
plt.show()
