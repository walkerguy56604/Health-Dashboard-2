<script>
let readingsData = [];

// Fetch latest readings with cache-buster
function loadReadings() {
  fetch(`latest.json?ts=${new Date().getTime()}`)
    .then(response => response.json())
    .then(data => {
      readingsData = data;
      displayReadings(true); // 'true' triggers highlight for newest
    });
}

// Display readings in table
function displayReadings(highlightNew = false) {
  const tbody = document.querySelector('#readings-table tbody');
  tbody.innerHTML = '';

  readingsData.forEach((reading, index) => {
    const row = document.createElement('tr');
    
    // Create table cells
    ['date', 'systolic', 'diastolic', 'pulse', 'IHB', 'arm', 'position', 'symptoms', 'notes'].forEach(key => {
      const cell = document.createElement('td');
      cell.textContent = reading[key];
      row.appendChild(cell);
    });

    // Highlight newest reading if flag is true
    if (highlightNew && index === readingsData.length - 1) {
      row.classList.add('highlight');
      setTimeout(() => row.classList.remove('highlight'), 2000);
    }

    tbody.appendChild(row);
  });
}

// Sort by table headers
document.querySelectorAll('th').forEach((th) => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    readingsData.sort((a, b) => {
      if (key === 'date') return new Date(b.date) - new Date(a.date);
      return (b[key] || '').toString().localeCompare((a[key] || '').toString(), undefined, {numeric: true});
    });
    displayReadings();
  });
});

// Initial load & refresh every 20 seconds
loadReadings();
setInterval(loadReadings, 20000);
</script>
