<script>
let readingsData = [];

async function loadReadings() {
  try {
    const res = await fetch('latest.json?ts=' + Date.now());
    const data = await res.json();
    readingsData = Array.isArray(data) ? data : [data];
    displayReadings(true);
  } catch (e) {
    console.error('Failed to load JSON', e);
  }
}

function displayReadings(highlightNew = false) {
  const tbody = document.querySelector('tbody');
  tbody.innerHTML = '';

  readingsData
    .sort((a, b) => new Date(b.date) - new Date(a.date))
    .forEach((r, index) => {
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${new Date(r.date).toLocaleString()}</td>
        <td>${r.systolic}</td>
        <td>${r.diastolic}</td>
        <td>${r.pulse}</td>
        <td>${r.IHB}</td>
        <td>${r.arm}</td>
        <td>${r.position}</td>
        <td>${r.symptoms}</td>
        <td>${r.notes}</td>
      `;

      if (highlightNew && index === 0) {
        row.classList.add('highlight');
        setTimeout(() => row.classList.remove('highlight'), 2000);
      }

      tbody.appendChild(row);
    });
}

// Column sorting
document.querySelectorAll('th').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    readingsData.sort((a, b) => {
      if (key === 'date') return new Date(b.date) - new Date(a.date);
      return (b[key] ?? '')
        .toString()
        .localeCompare((a[key] ?? '').toString(), undefined, { numeric: true });
    });
    displayReadings();
  });
});

// Initial load + auto refresh
loadReadings();
setInterval(loadReadings, 20000);
</script>
